---
description: Launch the application (Dev or Prod) with standardized environment checks.
globs: 
---

# Launch Application Command

Use this command to reliably start the application. It handles stack detection, dependency installation, environment validation, and port management automatically.

## Usage

@agent: When asked to "start the app", "run the server", or "launch", follow this procedure.

**Parameters:**
- `env`: `dev` (default) or `prod`
- `service`: (Optional) Sub-directory for monorepo services (e.g., `frontend`, `backend`)
- `skip-tests`: `true` or `false` (default: `false`)
- `skip-install`: `true` or `false` (default: `false`)

---

## Execution Steps

### 1. Context & Stack Detection
1.  **Service Selection:**
    - If `service` argument is provided, `cd` into that directory.
    - Else, detect if root is the app or a monorepo.
2.  **Stack Identification:**
    - **Node.js:** Look for `package.json`.
    - **Python:** Look for `requirements.txt`, `pyproject.toml`, or `Pipfile`.
    - **Docker:** Look for `docker-compose.yml`.

### 2. Configuration Resolution
1.  **Environment File:**
    - Ensure `.env` (or `.env.local` for Next.js) exists.
    - If missing, copy from `.env.example` (if available) and notify the user to fill secrets.
2.  **Supabase Setup Check:**
    - If project uses Supabase, check if `supabase/` directory exists.
    - If missing, notify user that Supabase must be initialized first (see `standards/architecture/supabase-local-setup.md`).
    - Verify `.env.local` contains Supabase credentials (run `supabase status` if needed).
3.  **Port & URL:**
    - Read `PORT` and `PROJECT_ROOT_URL` from config.
    - Default `PORT`: 3000 (Node), 8000 (Python/Django), 54321 (Supabase API).
    - Default `PROJECT_ROOT_URL`: `http://localhost:<PORT>`.

### 3. Dependency Validation (Self-Healing)
*Unless `skip-install=true`*
1.  **Node:** Check `node_modules`. If missing/stale, run `npm install` (or `yarn`/`pnpm`).
2.  **Python:** Check `.venv`. If missing, create it and run `pip install -r requirements.txt`.

### 4. Pre-Flight Checks
*Unless `skip-tests=true`*
1.  Run fast checks: `npm run lint` or `npm test` (unit only).
2.  If checks fail, **ABORT** and report errors.

### 5. Launch Sequence

#### A. Development (`env=dev`)
*Command: `launch_application_dev`*

1.  **Supabase Startup (if applicable):**
    - If `supabase/` directory exists, check if Supabase is running: `supabase status`
    - If not running, start with: `supabase start`
    - **CRITICAL:** Only use `supabase start/stop` commands. Never use `docker stop $(docker ps -q)` as this affects all projects.
    - Wait for Supabase services to be ready before starting the application.
2.  **Check Port:**
    - If `PORT` is in use, use `self_healing` rule to identify and handle the conflict.
    - **For Supabase ports (54321, 54322, etc.):** Verify it's the current project's container using `supabase status` before stopping.
3.  **Start Server:**
    - **Node:** `npm run dev`
    - **Python:** `python manage.py runserver` or `uvicorn main:app --reload`
4.  **Verification:**
    - Monitor logs for "Server running" message.
    - If Supabase is used, verify connection by checking for successful database/auth initialization.
    - Output: "üöÄ Application running at `PROJECT_ROOT_URL`"

#### B. Production (`env=prod`)
*Command: `launch_application_prod`*

1.  **Build:** `npm run build` (Node) or compile steps.
2.  **Start:** `npm start` or production runner (e.g., `gunicorn`).
3.  **Note:** Ensure production env vars are loaded.

---

## Error Handling

- **Port Conflicts:** "Port X is busy. Killing PID Y..." (Auto-fix)
  - **For Supabase ports:** Verify container ownership with `supabase status` before stopping. Only stop containers belonging to the current project.
- **Missing Dependencies:** "node_modules missing. Installing..." (Auto-fix)
- **Build Failures:** Stop and display log output.
- **Supabase Connection Errors:**
  - Verify Supabase is running: `supabase status`
  - Check `.env.local` has correct credentials from `supabase status`
  - Ensure Docker is running if using local Supabase
  - See `standards/architecture/supabase-local-setup.md` for troubleshooting

## Container Isolation Rules (CRITICAL)

When working with Supabase or Docker:

1. **Always use project-specific commands:**
   - ‚úÖ `supabase start` - Starts only current project's containers
   - ‚úÖ `supabase stop` - Stops only current project's containers
   - ‚úÖ `supabase status` - Shows only current project's status

2. **Never use broad Docker commands:**
   - ‚ùå `docker stop $(docker ps -q)` - Affects ALL containers
   - ‚ùå `docker-compose down` (if used globally) - Affects all projects

3. **If you must use Docker directly:**
   - Filter by project reference: `docker ps --filter "name=supabase_<project-ref>"`
   - Verify container ownership with `supabase status` first

4. **Port conflict resolution:**
   - Identify which project owns the conflicting container
   - Only stop containers belonging to the current project
   - If unsure, ask the user which project should use the port

See `standards/architecture/supabase-local-setup.md` Section 10 for detailed container management guidelines.
